<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pinjam Buku | Lib-Geo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-blue-50 min-h-screen">
    <script>
        if (localStorage.getItem('role') !== 'user') {
            alert("Silakan login sebagai Mahasiswa!");
            window.location.href = '/';
        }
    </script>

    <nav class="bg-blue-600 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <span class="font-bold text-lg"><i class="fas fa-book mr-2"></i> Katalog Perpustakaan</span>
            <div class="flex items-center space-x-4">
                <span id="userBadge" class="bg-blue-700 px-3 py-1 rounded text-sm font-mono">
                    ID: ${localStorage.getItem('userId')}
                </span>
                <button onclick="logout()" class="text-sm bg-blue-800 px-3 py-1 rounded hover:bg-blue-900 transition font-bold">Logout</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-6 py-10">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-blue-900">Selamat Datang, <span id="displayUser">User</span></h2>
            <p class="text-blue-600">Silakan pilih buku yang ingin Anda pinjam hari ini.</p>
        </div>
        <div id="catalog" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            </div>
    </main>

    <script>
        document.getElementById('displayUser').innerText = localStorage.getItem('username') || 'Mahasiswa';
        document.getElementById('userBadge').innerText = `ID: ${localStorage.getItem('userId')}`;

        async function loadCatalog() {
            const res = await fetch('/api/books');
            const books = await res.json();
            document.getElementById('catalog').innerHTML = books.map(b => `
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-600 hover:shadow-lg transition">
                    <h3 class="text-xl font-bold">${b.title}</h3>
                    <p class="text-gray-500 text-sm mb-4 italic">Penulis: ${b.author}</p>
                    <div class="flex justify-between items-center">
                        <span class="${b.stock > 0 ? 'text-green-600' : 'text-red-600'} font-bold">Stok: ${b.stock}</span>
                        <button onclick="borrowBook(${b.id})" 
                            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition font-bold ${b.stock <= 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${b.stock <= 0 ? 'disabled' : ''}>
                            Pinjam
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function borrowBook(bookId) {
            const userId = localStorage.getItem('userId');
            
            // tampilan ketia loading saat cek GPs
            console.log("Mendeteksi lokasi...");
            
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const res = await fetch('/api/borrow', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'x-user-role': localStorage.getItem('role'), 
                        'x-user-id': userId 
                    },
                    body: JSON.stringify({
                        bookId: bookId,
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude
                    })
                });
                
                const data = await res.json();
                alert(data.message);
                loadCatalog();
            }, (err) => {
                alert("Gagal meminjam: Izin lokasi (Geolocation) wajib aktif!");
            });
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }

        loadCatalog();
    </script>
</body>
</html>